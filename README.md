# EmotionAI - 高级情感智能交互插件

基于 AstrBot 的高级情感智能交互插件，为 AI 提供多维度的情感模拟和智能交互体验。

## 插件信息

**插件名称**: EmotionAI  
**作者**: 腾天  
**版本**: v2.2.0  
**兼容性**: AstrBot 框架

## 简介

EmotionAI 是一个高级情感智能交互插件，旨在为 AI 模拟一个多维度的、自主演变的内心世界。与传统的单一好感度系统不同，本插件提供了更丰富的情感维度和更智能的交互体验。

## 功能特色

### 🎭 多维情感模型
- **8种基础情感**：喜悦、信任、恐惧、惊讶、悲伤、厌恶、愤怒、期待
- **复合情感状态**：好感度、亲密度
- **动态关系系统**：从陌生人到亲密关系的渐进演变
- **智能情感分析**：自动识别主导情感和行为模式

### 🛡️ 智能管理系统
- **排行榜功能**：查看好感度和亲密度平均值排行榜
- **个性化设置**：每个用户可以独立控制状态显示
- **管理员工具**：完整的管理员命令集
- **优先级控制**：可配置插件执行优先级，避免与其他插件冲突

### ⚡ 性能优化
- **异步缓存系统**：使用异步锁避免阻塞事件循环
- **智能缓存策略**：排行榜和统计信息缓存减少重复计算
- **跨平台兼容**：支持任意格式的用户ID
- **详细调试日志**：完整的处理过程监控和诊断

### ⚙️ 灵活配置
- 可自定义好感度上下限
- 可调整单次好感度变化范围
- 支持会话独立模式
- 可配置管理员列表
- **可调整插件优先级**：避免与其他插件冲突

## 配置说明

### 配置项详情

- **session_based**: 是否启用会话独立模式
- **favour_min**: 好感度最小值
- **favour_max**: 好感度最大值
- **change_min**: 单次好感度减少最大值
- **change_max**: 单次好感度增加最大值
- **admin_qq_list**: 管理员QQ号列表
- **plugin_priority**: 插件处理优先级（**新增**）

### 优先级配置说明

#### 插件优先级的重要性

EmotionAI 插件依赖于解析LLM响应中的情感更新标记 `[情感更新: joy:1, favor:1]` 来更新情感状态。但某些其他插件（如 `meme_manager`）可能会在处理过程中移除这些标记，导致情感更新失效。

#### 解决方案

插件新增了 `plugin_priority` 配置项，用于设置插件处理消息的优先级：

- **默认值**: 100000（非常高）
- **作用**: 确保EmotionAI插件在其他可能干扰的插件之前处理LLM响应
- **调整建议**: 
  - 如果遇到与其他插件的冲突，可以适当调整此值
  - 数字越大，插件越先执行
  - 建议设置为100000以上以避免被常见插件干扰

#### 配置示例

```json
{
  "plugin_priority": 100000,
  "session_based": false,
  "favour_min": -100,
  "favour_max": 100,
  "change_min": -10,
  "change_max": 5,
  "admin_qq_list": ["123456789", "987654321"]
}
```

## 使用指南

### 用户命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `/好感度` | 查看当前情感状态 | `/好感度` |
| `/状态显示` | 切换是否在对话后显示状态信息 | `/状态显示` |
| `/好感排行` | 显示好感度平均值前N名用户 | `/好感排行 5` |
| `/负好感排行` | 显示好感度平均值后N名用户 | `/负好感排行 3` |
| `/缓存统计` | 查看缓存使用情况 | `/缓存统计` |

### 管理员命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `/设置好感 <用户ID> <数值>` | 设置用户好感度 | `/设置好感 123456 50` |
| `/重置好感 <用户ID>` | 重置用户好感度状态 | `/重置好感 123456` |
| `/查看好感 <用户ID>` | 查看指定用户情感状态 | `/查看好感 123456` |
| `/重置插件` | 重置插件所有数据 | `/重置插件` |
| `/备份数据` | 备份插件数据 | `/备份数据` |

## 情感更新机制

### 工作原理

EmotionAI 通过LLM在回复中使用特定的情感更新标记来更新情感状态：

```
[情感更新: joy:1, trust:1, favor:2]
```

### 可用情感维度

**基础情感**:
- `joy` (喜悦)
- `trust` (信任)
- `fear` (恐惧)
- `surprise` (惊讶)
- `sadness` (悲伤)
- `disgust` (厌恶)
- `anger` (愤怒)
- `anticipation` (期待)

**关系状态**:
- `favor` (好感度)
- `intimacy` (亲密度)

### 情感响应指导

LLM会根据对话内容自动调整情感状态：

- **开心/愉快**：适当增加 `joy` (1-3)
- **信任/安心**：适当增加 `trust` (1-2)
- **惊讶**：适当增加 `surprise` (1-2)
- **期待**：适当增加 `anticipation` (1-2)
- **不开心**：适当增加 `sadness` (1-2)
- **生气**：适当增加 `anger` (1-2)
- **害怕**：适当增加 `fear` (1-2)
- **厌恶**：适当增加 `disgust` (1-2)

## 状态显示格式

当开启状态显示时，每次对话后会显示如下格式的状态信息：

```
【当前情感状态】
==================
好感度：23 | 亲密度：15
关系：熟人 | 趋势：好感领先
态度：中立 | 主导情感：信任
互动：12次 (频繁互动)
正面互动：66.7%

【情感维度详情】
  喜悦：5 | 信任：8 | 恐惧：1 | 惊讶：3
  悲伤：2 | 厌恶：0 | 愤怒：1 | 期待：5
```

## 技术特性

### 性能优化
- **异步操作**：所有缓存操作使用异步锁，避免阻塞事件循环
- **智能缓存**：排行榜和统计信息缓存，减少重复计算
- **内存管理**：合理的缓存大小和TTL设置
- **优先级控制**：可配置的执行优先级，避免插件冲突

### 跨平台兼容
- 支持任意格式的用户ID（数字、字母、混合）
- 兼容QQ、Telegram、Discord等平台
- 保持向后兼容性

### 数据安全
- 自动保存机制，防止数据丢失
- 数据备份功能
- 异常恢复机制
- 详细的调试日志

### 调试功能

插件提供了完整的调试日志系统，可以监控：

1. **原始LLM响应内容**
2. **情感更新标记的解析过程**
3. **状态变化的详细信息**
4. **插件执行优先级信息**
5. **缓存命中率和性能统计**

## 版本历史

### v2.2.0 (当前版本)
- **优先级配置**：新增 `plugin_priority` 配置项，避免与其他插件冲突
- **增强调试**：添加详细的处理过程日志，便于诊断问题
- **性能优化**：改进缓存策略和状态更新逻辑
- **文档完善**：更新配置说明和故障排除指南

### v2.1.1
- **增强提示词**：改进LLM情感更新提示，提高更新频率
- **调试监控**：添加情感更新解析和状态变化日志
- **问题修复**：解决情感更新标记被其他插件移除的问题

### v2.1.0
- **性能优化**：使用异步锁替换线程锁，避免阻塞事件循环
- **缓存优化**：为排行榜和统计信息添加智能缓存
- **跨平台兼容**：移除用户ID格式限制，支持任意平台
- **代码重构**：模块化设计，职责分离，提高可维护性

### v1.1.3
- 修复黑名单实时拦截问题
- 改进重置插件功能
- 增强状态同步机制

### v1.1.2
- 修复 UnboundLocalError 错误
- 优化情感更新处理逻辑

### v1.1.1
- 修复重置好感功能
- 添加重置插件命令
- 优化状态显示逻辑

### v1.1.0
- 添加排行榜功能
- 扩展配置选项
- 更新管理员命令

### v1.0.0
- 初始版本发布
- 基础情感维度系统
- 用户个性化设置

## 常见问题

### Q: 情感状态没有更新怎么办？
A: 请检查以下事项：
1. **插件优先级**：确认 `plugin_priority` 设置足够高（建议100000+）
2. **调试日志**：查看日志确认情感更新标记是否被正确解析
3. **LLM提示**：确保LLM理解并使用情感更新格式
4. **插件冲突**：检查是否有其他插件干扰情感更新标记

### Q: 如何重置某个用户的状态？
A: 管理员可以使用 `/重置好感 <用户ID>` 命令完全重置用户状态。

### Q: 插件数据存储在哪里？
A: 插件数据存储在 `data/emotionai/` 目录下的 JSON 文件中。

### Q: 如何调整好感度变化范围？
A: 在插件配置中修改 `change_min` 和 `change_max` 参数。

### Q: 管理员命令在会话独立模式下是否正常工作？
A: 是的，管理员命令现在可以跨会话正常操作。

### Q: 如何确认插件优先级生效？
A: 查看插件初始化日志，会显示当前设置的优先级值：
```
[EmotionAI] 插件初始化完成 - 优先级版本 (优先级: 100000)
```

### Q: 遇到插件冲突怎么办？
A: 
1. 首先提高 `plugin_priority` 值（如设置为150000）
2. 查看调试日志确认情感更新标记的处理过程
3. 如果问题持续，可以暂时禁用可能冲突的其他插件进行测试

## 支持与反馈

如果您在使用过程中遇到问题或有改进建议，欢迎通过以下方式联系：

- 提交 GitHub Issue
- 联系插件作者

**项目仓库**: [https://github.com/tengtian3/astrbot-plugin-emotionai](https://github.com/tengtian3/astrbot-plugin-emotionai)

## 许可证

本项目采用 MIT 许可证。

---

**温馨提示**: 为了获得最佳体验，建议将 `plugin_priority` 设置为较高的值（如100000），以确保情感更新标记在其他插件处理之前被正确解析。如果遇到任何问题，请查看调试日志获取详细信息。